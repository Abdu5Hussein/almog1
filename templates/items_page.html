<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام طلب المنتجات</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --success-color: #2ecc71;
    }

    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
      margin-top: 20px;
      margin-bottom: 50px;
    }

    .header-section {
      background-color: var(--secondary-color);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .fixed-header, .filters, .page-input {
      position: sticky;
      top: 0;
      background-color: #f5f7fa;
      z-index: 100;
      padding-bottom: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .scroll-table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background-color: white;
    }

    .spinner-border {
      color: var(--primary-color);
    }

    .modal-img {
      width: 100%;
      border-radius: 8px;
    }

    .img-thumbnail {
      height: 60px;
      width: 60px;
      object-fit: contain;
      cursor: pointer;
      border-radius: 4px;
      transition: transform 0.2s;
    }

    .img-thumbnail:hover {
      transform: scale(1.05);
    }

    /* Grid table styling */
    #productList {
      width: 100%;
    }

    #productList thead tr {
      display: grid;
      grid-template-columns: 80px 1fr 1fr 1fr 120px 2fr 100px 120px 100px 100px;
      background-color: var(--secondary-color);
      color: white;
    }

    #productList tbody tr {
      display: grid;
      grid-template-columns: 80px 1fr 1fr 1fr 120px 2fr 100px 120px 100px 100px;
      align-items: center;
      transition: background-color 0.2s;
    }

    #productList th, #productList td {
      padding: 12px 8px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border: 1px solid #dee2e6;
    }

    #productList th {
      font-weight: 600;
    }

    #productList tbody tr:hover {
      background-color: #f8f9fa !important;
    }

    /* Stock level coloring */
    #productList tr[data-stock="0"] {
      background-color: #ffebee !important;
    }

    #productList tr[data-stock="0"] td:first-child {
      border-left: 4px solid var(--danger-color);
    }

    #productList tr[data-stock="1"],
    #productList tr[data-stock="2"] {
      background-color: #fff8e1 !important;
    }

    #productList tr[data-stock="1"] td:first-child,
    #productList tr[data-stock="2"] td:first-child {
      border-left: 4px solid var(--warning-color);
    }

    #productList tr[data-stock="3"] td:first-child {
      border-left: 4px solid var(--success-color);
    }
.clickable-cell {
  transition: background-color 0.2s;
}

.clickable-cell:hover {
  background-color: #f0f0f0 !important;
}

/* Ensure quantity controls don't trigger the click event */
.quantity-control, .quantity-control * {
  pointer-events: auto;
  cursor: default;
}

    /* Quantity controls */
    .quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quantity-input {
      width: 50px;
      text-align: center;
      margin: 0 5px;
    }

    .quantity-btn {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    /* Cart sidebar */
    .cart-sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background-color: white;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: right 0.3s;
      padding: 20px;
      overflow-y: auto;
    }

    .cart-sidebar.open {
      right: 0;
    }

    .cart-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }

    .cart-overlay.open {
      display: block;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .cart-item-img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      border-radius: 4px;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
      #productList thead tr,
      #productList tbody tr {
        grid-template-columns: 80px 1fr 1fr 120px 2fr 100px 120px 100px 100px;
      }
      
      .engine-col {
        display: none;
      }
    }

    @media (max-width: 992px) {
      #productList thead tr,
      #productList tbody tr {
        grid-template-columns: 80px 1fr 120px 2fr 100px 100px 100px;
      }
      
      .subtype-col, .company-col {
        display: none;
      }
    }

    @media (max-width: 768px) {
      #productList thead tr,
      #productList tbody tr {
        grid-template-columns: 80px 2fr 100px 100px 100px;
      }
      
      .maintype-col, .location-col {
        display: none;
      }
      
      .cart-sidebar {
        width: 300px;
      }
    }

    /* Badge for cart button */
    .cart-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #b8b8b8;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }

    /* Print styles */
    @media print {
      body * {
        visibility: hidden;
      }
      .print-section, .print-section * {
        visibility: visible;
      }
      .print-section {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .no-print {
        display: none !important;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm" style="background-color: #1a237e; border-bottom: 2px solid #3949ab; font-size: 0.9rem;">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="/home" aria-label="الرئيسية" style="font-size: 1.3rem; color: #ffca28; letter-spacing: 1px; text-shadow: 0 0 5px #ffca28;">
        متجر المنتجات
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="تبديل التنقل" style="border-color: #ffca28;">
        <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item">
            <a class="nav-link" href="/home" aria-current="page" style="color: #c5cae9; transition: color 0.3s ease;">
              <i class="bi bi-house-door-fill me-1" style="font-size: 1.1rem;"></i> الرئيسية
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/products" style="color: #c5cae9; transition: color 0.3s ease;">
              <i class="bi bi-box-seam me-1" style="font-size: 1.1rem;"></i> المنتجات
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/orders" style="color: #c5cae9; transition: color 0.3s ease;">
              <i class="bi bi-card-checklist me-1" style="font-size: 1.1rem;"></i> الطلبات
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/contact" style="color: #c5cae9; transition: color 0.3s ease;">
              <i class="bi bi-envelope-fill me-1" style="font-size: 1.1rem;"></i> تواصل معنا
            </a>
          </li>
          <li class="nav-item position-relative">
            <a id="navbarCartIcon" class="nav-link" href="javascript:void(0);" title="السلة" role="button" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-label="عرض السلة" onclick="toggleCart()" style="color: #c5cae9; transition: color 0.3s ease;">
              <i class="bi bi-cart3" aria-hidden="true" style="font-size: 1.4rem;"></i>
              <span id="cartBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" aria-live="polite" aria-atomic="true" style="font-size: 0.7rem;">0</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <style>
    .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active {
      color: #ffca28 !important;
      text-shadow: 0 0 5px #ffca28;
    }
  </style>

  <style>
    /* RTL adjustments */
    body {
      direction: rtl;
    }
    .navbar-nav .nav-link {
      font-weight: 600;
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }
    .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active {
      color: #0d6efd;
    }
    .form-control {
      max-width: 250px;
    }
  </style>

  <style>
    /* Custom Navbar inspired by marin.ly */
    .custom-navbar {
      position: fixed;
      width: 100%;
      top: 0;
      right: 0;
      background: transparent;
      z-index: 10000;
      transition: background-color 0.4s ease, box-shadow 0.4s ease;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
    }

    .custom-navbar.scrolled {
      background: #0d6efd;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .custom-navbar .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .navbar-logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
      text-decoration: none;
      letter-spacing: 1px;
      transition: color 0.3s ease;
    }

    .navbar-logo:hover {
      color: #ffd54f;
      text-shadow: 0 0 8px #ffd54f;
    }

    /* Menu Icon for mobile */
    #menu-toggle {
      display: none;
    }

    .menu-icon {
      cursor: pointer;
      display: none;
      width: 30px;
      height: 25px;
      position: relative;
      -webkit-transform: rotate(0deg);
      transform: rotate(0deg);
      -webkit-transition: .5s ease-in-out;
      transition: .5s ease-in-out;
    }

    .menu-icon .navicon {
      background: white;
      display: block;
      position: absolute;
      height: 3px;
      width: 100%;
      border-radius: 3px;
      opacity: 1;
      left: 0;
      top: 0;
      -webkit-transform: rotate(0deg);
      transform: rotate(0deg);
      -webkit-transition: .25s ease-in-out;
      transition: .25s ease-in-out;
    }

    .menu-icon .navicon:before,
    .menu-icon .navicon:after {
      content: '';
      background: white;
      display: block;
      position: absolute;
      height: 3px;
      width: 100%;
      border-radius: 3px;
      opacity: 1;
      left: 0;
      -webkit-transition: .25s ease-in-out;
      transition: .25s ease-in-out;
    }

    .menu-icon .navicon:before {
      top: 8px;
    }

    .menu-icon .navicon:after {
      top: 16px;
    }

    #menu-toggle:checked + .menu-icon .navicon {
      background: transparent;
    }

    #menu-toggle:checked + .menu-icon .navicon:before {
      -webkit-transform: rotate(45deg);
      transform: rotate(45deg);
      top: 0;
    }

    #menu-toggle:checked + .menu-icon .navicon:after {
      -webkit-transform: rotate(-45deg);
      transform: rotate(-45deg);
      top: 0;
    }

    /* Navigation Menu */
    .nav-menu {
      list-style: none;
      display: flex;
      margin: 0;
      padding: 0;
    }

    .nav-menu li {
      margin-left: 1.5rem;
    }

    .nav-menu li a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.1rem;
      position: relative;
      padding: 0.5rem 0;
      transition: color 0.3s ease;
    }

    .nav-menu li a::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: 0;
      left: 0;
      background-color: #ffd54f;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .nav-menu li a:hover,
    .nav-menu li a.active {
      color: #ffd54f;
    }

    .nav-menu li a:hover::after,
    .nav-menu li a.active::after {
      width: 100%;
    }

    /* Responsive */
    @media (max-width: 991px) {
      .menu-icon {
        display: block;
      }

      .nav-menu {
        position: fixed;
        top: 60px;
        right: 0;
        background: #0d6efd;
        height: calc(100% - 60px);
        width: 250px;
        flex-direction: column;
        align-items: flex-start;
        padding: 1rem;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: -2px 0 10px rgba(0,0,0,0.2);
        z-index: 9999;
      }

      #menu-toggle:checked ~ .nav-menu {
        transform: translateX(0);
      }

      .nav-menu li {
        margin: 1rem 0;
        width: 100%;
      }

      .nav-menu li a {
        width: 100%;
        font-size: 1.3rem;
      }
    }
  </style>

  <style>
    /* Animated Navbar Styles */
    .animated-navbar {
      transition: background-color 0.4s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .animated-navbar .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 1px;
      transition: color 0.3s ease;
    }

    .animated-navbar .navbar-brand:hover {
      color: #ffd54f;
      text-shadow: 0 0 8px #ffd54f;
    }

    .animated-navbar .nav-link {
      position: relative;
      font-weight: 600;
      font-size: 1.1rem;
      padding: 0.5rem 1rem;
      transition: color 0.3s ease;
    }

    .animated-navbar .nav-link::after {
      content: '';
      position: absolute;
      width: 0;
      height: 3px;
      bottom: 0;
      left: 0;
      background-color: #ffd54f;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .animated-navbar .nav-link:hover {
      color: #ffd54f;
    }

    .animated-navbar .nav-link:hover::after {
      width: 100%;
    }

    .animated-navbar .nav-link.active {
      color: #ffca28;
    }

    /* Navbar background change on scroll */
    .navbar-scrolled {
      background-color: #1e88e5 !important;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: background-color 0.4s ease;
    }
  </style>

  <script>
    // Change navbar background on scroll
    document.addEventListener('scroll', function() {
      const navbar = document.querySelector('.animated-navbar');
      if (window.scrollY > 50) {
        navbar.classList.add('navbar-scrolled');
      } else {
        navbar.classList.remove('navbar-scrolled');
      }
    });
  </script>

  <!-- Cart Overlay -->
  <div class="cart-overlay" id="cartOverlay"></div>

  <!-- Cart Sidebar -->
  <div class="cart-sidebar" id="cartSidebar">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4>سلة الطلبات</h4>
      <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">
        <i class="bi bi-trash"></i> إفراغ السلة
      </button>
    </div>
    
    <div id="cartItemsContainer">
      <p class="text-muted text-center py-4">السلة فارغة</p>
    </div>
    
    <div class="mt-3 border-top pt-3">
      <div class="d-flex justify-content-between mb-2">
        <span>عدد الأصناف:</span>
        <strong id="cartItemsCount">0</strong>
      </div>
      <div class="d-flex justify-content-between mb-3">
        <span>المجموع:</span>
        <strong id="cartTotalAmount">0.00 د.أ</strong>
      </div>
      <button class="btn btn-primary w-100" onclick="submitOrder()">
        <i class="bi bi-send-check"></i> إرسال الطلب
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Header Section -->
    <div class="header-section">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h2 class="mb-0"><i class="bi bi-cart-check"></i> نظام طلب المنتجات</h2>
        </div>
        <div class="col-md-6 text-left">
          
          <button id="printCartButton" class="btn btn-outline-light ms-2" type="button">
            <i class="bi bi-printer"></i> طباعة
          </button>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters row mb-4 g-3">
      <div class="col-md-3 col-sm-6">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
          <input id="modelFilter" class="form-control" placeholder="رقم القطعة">
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-gear"></i></span>
          <input id="engineFilter" class="form-control" placeholder="رقم المحرك">
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-tags"></i></span>
          <input id="mainTypeFilter" class="form-control" placeholder="الصنف الرئيسي">
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-tag"></i></span>
          <input id="subTypeFilter" class="form-control" placeholder="الصنف الفرعي">
        </div>
      </div>
    </div>

    <div class="text-center mb-4">
      <button onclick="applyFilters()" class="btn btn-primary me-2">
        <i class="bi bi-search"></i> بحث
      </button>
      <button onclick="resetFilters()" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-counterclockwise"></i> إعادة تعيين
      </button>
    </div>

    <!-- Page Navigation -->
    <div class="page-input row mb-3 g-3 align-items-center">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text">الصفحة</span>
          <input id="pageInput" type="number" class="form-control" min="1" value="1" onchange="changePage()">
          <button class="btn btn-outline-secondary" onclick="prevPage()"><i class="bi bi-chevron-right"></i></button>
          <button class="btn btn-outline-secondary" onclick="nextPage()"><i class="bi bi-chevron-left"></i></button>
        </div>
      </div>
      <div class="col-md-4 text-center">
        <span id="pageInfo">الصفحة 1 من 1</span>
      </div>
      <div class="col-md-4 text-left">
        <div class="input-group">
          <span class="input-group-text">العناصر لكل صفحة</span>
          <select id="itemsPerPage" class="form-select" onchange="changeItemsPerPage()">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="scroll-table-container">
      <table class="table table-bordered mb-0">
        <thead>
          <tr>
            <th>رقم القطعة</th>
            <th class="maintype-col">الصنف الرئيسي</th>
            <th class="subtype-col">الصنف الفرعي</th>
            <th class="engine-col">رقم المحرك</th>
            <th class="location-col">الموديل</th>
            <th>اسم القطعة</th>
            <th>السعر</th>
            <th class="company-col">الشركة</th>
            <th>المخزون</th>
            <th>الكمية</th>
            <th>شراء</th>
          </tr>
        </thead>
        <tbody id="productList"></tbody>
      </table>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center py-4" style="display:none;">
      <div class="spinner-border" role="status"></div>
      <p class="mt-2">جارٍ تحميل البيانات...</p>
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="text-center py-5" style="display:none;">
      <i class="bi bi-exclamation-circle" style="font-size: 3rem; color: #6c757d;"></i>
      <h4 class="mt-3">لا توجد نتائج</h4>
      <p class="text-muted">لم يتم العثور على منتجات تطابق معايير البحث الخاصة بك</p>
    </div>
  </div>

  <!-- Modal for Full Image -->
  <div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">صورة المنتج</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalImage" class="modal-img" src="" alt="Product Image" style="max-height: 70vh;">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Success Modal -->
  <div class="modal fade" id="orderSuccessModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">تم إرسال الطلب بنجاح</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
          <p class="mt-3">تم إرسال طلبك بنجاح وسيتم معالجته قريباً</p>
          <p>رقم الطلب: <strong id="orderNumber"></strong></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">موافق</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Product Images -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">صور المنتج</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Images will be loaded here dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const baseUrl = "http://45.13.59.226";
    const jwtToken_access = localStorage.getItem("session_data@access_token")?.replace(/"/g, '');
    const cart = JSON.parse(localStorage.getItem('product_cart')) || [];
    
    let currentPage = 1;
    let lastPage = 1;
    let isLoading = false;
    let currentFilters = {};
    let itemsPerPage = 10;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      updateCartUI();
      applyFilters();
      
      // Add event listener for Enter key in filter inputs
      const filterInputs = document.querySelectorAll('.filters input');
      filterInputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            applyFilters();
          }
        });
      });

      // Navbar search form submit handler
      const navbarSearchForm = document.getElementById('navbarSearchForm');
      const navbarSearchInput = document.getElementById('navbarSearchInput');
      navbarSearchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const searchTerm = navbarSearchInput.value.trim();
        // Apply search term to filters (search by itemno or itemname)
        currentFilters.itemno = searchTerm;
        currentFilters.itemmain = '';
        currentFilters.itemsubmain = '';
        currentFilters.engine_no = '';
        currentPage = 1;
        document.getElementById('pageInput').value = 1;
        document.getElementById('productList').innerHTML = "";
        document.getElementById('loading-spinner').style.display = 'block';
        loadMoreItems();
      });

      // Navbar cart icon click handler to toggle cart sidebar
      const navbarCartIcon = document.getElementById('navbarCartIcon');
      navbarCartIcon.addEventListener('click', function(e) {
        e.preventDefault();
        toggleCart();
      });

      // Print cart button handler to print only cart sidebar content
      const printCartButton = document.getElementById('printCartButton');
      printCartButton.addEventListener('click', function() {
        printCartItems();
      });
    });

    // Function to print only the cart items list
    function printCartItems() {
      const cartSidebar = document.getElementById('cartSidebar');
      const originalContents = document.body.innerHTML;
      const printContents = cartSidebar.innerHTML;

      document.body.innerHTML = `<div class="print-section">${printContents}</div>`;
      window.print();
      document.body.innerHTML = originalContents;
      location.reload(); // Reload to restore event listeners and page state
    }

    async function fetchWithAuth(url, method = 'GET', body = null) {
      const headers = {
        'Authorization': `Bearer ${jwtToken_access}`,
        'Content-Type': 'application/json'
      };
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          if (response.status === 401) {
            alert("تم تسجيل الخروج بسبب انتهاء الجلسة.");
            localStorage.clear();
            window.location.href = "/login.html";
          }
          return null;
        }
        return await response.json();
      } catch (error) {
        console.error('Fetch error:', error);
        return null;
      }
    }

    async function getImageUrl(pno) {
      try {
        const response = await fetchWithAuth(`${baseUrl}/api/products/${pno}/get-images`);
        if (response && Array.isArray(response.images) && response.images.length > 0) {
          return `${baseUrl}${response.images[0]}`;
        }
      } catch (err) {
        console.error("Image fetch failed:", err);
      }
      return '';
    }

    async function fetchFilteredData(page = 1) {
      const filters = {
        itemno: currentFilters.itemno || '',
        itemmain: currentFilters.itemmain || '',
        itemsubmain: currentFilters.itemsubmain || '',
        engine_no: currentFilters.engine_no || '',
        itemthird: currentFilters.itemthird || '',
        page: page,
        size: itemsPerPage,
      };

      const response = await fetchWithAuth(`${baseUrl}/api/filter-items`, 'POST', filters);
      return {
        data: response?.data || [],
        last_page: response?.last_page || 1,
        total: response?.total || 0
      };
    }

    async function displayItems(items) {
      const productList = document.getElementById('productList');
      productList.innerHTML = ''; // Clear existing items
      
      if (items.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('loading-spinner').style.display = 'none';
        return;
      }
      
      document.getElementById('noResults').style.display = 'none';

    for (const item of items) {
      const row = document.createElement('tr');
      const stock = parseInt(item.itemvalue) || 0;
      // Check if item is in cart
      const cartItem = cart.find(ci => ci.pno === item.pno);
      const cartQuantity = cartItem ? cartItem.quantity : 0;

      // In your displayItems function, modify the row creation:
row.innerHTML = `
  <td class="clickable-cell" data-pno="${item.pno}">${item.itemno ?? '-'}</td>
  <td class="maintype-col clickable-cell" data-pno="${item.pno}">${item.itemmain ?? '-'}</td>
  <td class="subtype-col clickable-cell" data-pno="${item.pno}">${item.itemsubmain ?? '-'}</td>
  <td class="engine-col clickable-cell" data-pno="${item.pno}">${item.engine_no ?? '-'}</td>
  <td class="location-col clickable-cell" data-pno="${item.pno}">${item.itemthird ?? '-'}</td>
  <td class="clickable-cell" data-pno="${item.pno}">
    ${item.itemname ?? '-'}
  </td>
  <td>${parseFloat(item.buyprice || 0).toFixed(2)} د.أ</td>
  <td class="company-col">${item.companyproduct ?? '-'}</td>
  <td>
    ${stock > 5 ? 
      `<span class="badge bg-success">متوفر</span>` : 
      stock > 0 ? 
        `<span class="badge bg-warning text-dark">كمية محدودة</span>` : 
        `<span class="badge bg-danger">غير متوفر</span>`}
  </td>
  <td>
    <div class="quantity-control">
      <button class="btn btn-sm btn-outline-secondary quantity-btn" onclick="decrementQuantity('${item.pno}')">-</button>
      <input type="number" class="form-control form-control-sm quantity-input" 
        id="qty-${item.pno}" value="${cartQuantity}" min="0" 
        onchange="updateQuantity('${item.pno}', this.value)">
      <button class="btn btn-sm btn-outline-secondary quantity-btn" onclick="incrementQuantity('${item.pno}')">+</button>
    </div>
  </td>
  <td>
    <button class="btn btn-sm btn-success" onclick="addToCartWithQuantity('${item.pno}', '${item.itemno}', '${item.itemname}', ${parseFloat(item.buyprice || 0).toFixed(2)}, '', document.getElementById('qty-${item.pno}').value)">
      شراء
    </button>
  </td>
`

// Add click event to each clickable cell
row.querySelectorAll('.clickable-cell').forEach(cell => {
  cell.style.cursor = 'pointer';
  cell.addEventListener('click', (e) => {
    if (!e.target.classList.contains('quantity-btn') && 
        !e.target.classList.contains('quantity-input') &&
        !e.target.classList.contains('img-thumbnail')) {
      showProductImages(item.pno);
    }
  });
});
        productList.appendChild(row);
      }
    }


    async function showProductImages(pno) {
  try {
    console.log('Fetching images for product:', pno); // Debugging: Log product number

    // Show loading in modal
    const modalBody = document.querySelector('#imageModal .modal-body');
    modalBody.innerHTML = `
      <div class="text-center py-4">
        <div class="spinner-border" role="status"></div>
        <p class="mt-2">جارٍ تحميل الصور...</p>
      </div>
    `;
    console.log('Loading spinner displayed...'); // Debugging: Spinner is shown

    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
    console.log('Modal opened'); // Debugging: Modal opened

    // Fetch images from API
    const response = await fetchWithAuth(`${baseUrl}/api/products/${pno}/get-images`);
    console.log('API Response:', response); // Debugging: Log response from API

    if (response && Array.isArray(response) && response.length > 0) {
      console.log('Images found:', response); // Debugging: Log found images

      // Display all images in modal
      let imagesHTML = '';
response.forEach((imgObj, index) => {
  const imgUrl = `${baseUrl}${imgObj.image_obj}`;
  console.log(`Image ${index + 1}:`, imgUrl); // Log each image URL
  
  imagesHTML += `
    <div class="mb-3">
      <img src="${imgUrl}" class="img-fluid rounded mb-2" style="max-height: 60vh;">
      <div class="text-center">
        <a href="${imgUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-arrows-angle-expand"></i> فتح الصورة في نافذة جديدة
        </a>
      </div>
    </div>
  `;
});
console.log('Modal Content:', imagesHTML); // Debugging: Log HTML content
modalBody.innerHTML = imagesHTML;

      
      modalBody.innerHTML = imagesHTML;
      console.log('Images added to modal'); // Debugging: Log when images are added to modal
    } else {
      console.log('No images found for product:', pno); // Debugging: Log if no images are found
      modalBody.innerHTML = `
        <div class="text-center py-4">
          <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
          <p class="mt-3">لا توجد صور متاحة لهذا المنتج</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error fetching product images:', error); // Debugging: Log errors
    const modalBody = document.querySelector('#imageModal .modal-body');
    modalBody.innerHTML = `
      <div class="text-center py-4">
        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
        <p class="mt-3">حدث خطأ أثناء تحميل الصور</p>
      </div>
    `;
  }
}




    function showImageModal(url) {
      const modalImg = document.getElementById('modalImage');
      modalImg.src = url;
      const modal = new bootstrap.Modal(document.getElementById('imageModal'));
      modal.show();
    }

    function applyFilters() {
      currentFilters = {
        itemno: document.getElementById('modelFilter').value.trim(),
        engine_no: document.getElementById('engineFilter').value.trim(),
        itemmain: document.getElementById('mainTypeFilter').value.trim(),
        itemsubmain: document.getElementById('subTypeFilter').value.trim(),
      };
      currentPage = 1;
      document.getElementById('pageInput').value = 1;
      document.getElementById('productList').innerHTML = "";
      document.getElementById('loading-spinner').style.display = 'block';
      loadMoreItems();
    }

    function resetFilters() {
      document.getElementById('modelFilter').value = '';
      document.getElementById('engineFilter').value = '';
      document.getElementById('mainTypeFilter').value = '';
      document.getElementById('subTypeFilter').value = '';
      applyFilters();
    }

    function changePage() {
      const pageInput = document.getElementById('pageInput');
      const newPage = parseInt(pageInput.value, 10);
      if (newPage > 0 && newPage <= lastPage && newPage !== currentPage) {
        currentPage = newPage;
        document.getElementById('productList').innerHTML = "";
        document.getElementById('loading-spinner').style.display = 'block';
        loadMoreItems();
      } else {
        pageInput.value = currentPage;
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        document.getElementById('pageInput').value = currentPage - 1;
        changePage();
      }
    }

    function nextPage() {
      if (currentPage < lastPage) {
        document.getElementById('pageInput').value = currentPage + 1;
        changePage();
      }
    }

    function changeItemsPerPage() {
      itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
      currentPage = 1;
      document.getElementById('pageInput').value = 1;
      document.getElementById('productList').innerHTML = "";
      document.getElementById('loading-spinner').style.display = 'block';
      loadMoreItems();
    }

    async function loadMoreItems() {
      if (isLoading) return;
      isLoading = true;

      const { data, last_page, total } = await fetchFilteredData(currentPage);
      lastPage = last_page;
      
      await displayItems(data);
      updatePaginationInfo(total);
      
      document.getElementById('loading-spinner').style.display = 'none';
      isLoading = false;
    }

    function updatePaginationInfo(totalItems) {
      document.getElementById('pageInfo').textContent = 
        `الصفحة ${currentPage} من ${lastPage} | إجمالي العناصر: ${totalItems}`;
    }

    // Cart Functions
// Toggle cart visibility
function toggleCart() {
  const cartSidebar = document.getElementById('cartSidebar');
  const cartOverlay = document.getElementById('cartOverlay');
  const navbarCartIcon = document.getElementById('navbarCartIcon');

  const isOpen = cartSidebar.classList.toggle('open');
  cartOverlay.classList.toggle('open', isOpen);
  navbarCartIcon.setAttribute('aria-expanded', isOpen);

  if (isOpen) {
    // Save the element that had focus
    window.lastFocusedElement = document.activeElement;
    // Set focus to the cart sidebar
    cartSidebar.setAttribute('tabindex', '-1');
    cartSidebar.focus();
    // Disable background scroll
    document.body.style.overflow = 'hidden';
  } else {
    // Restore focus to the last focused element
    if (window.lastFocusedElement) {
      window.lastFocusedElement.focus();
    }
    // Enable background scroll
    document.body.style.overflow = '';
  }
}

// Close cart if clicked outside (on overlay)
document.getElementById('cartOverlay').addEventListener('click', function () {
  const cartSidebar = document.getElementById('cartSidebar');
  const cartOverlay = document.getElementById('cartOverlay');
  const navbarCartIcon = document.getElementById('navbarCartIcon');

  cartSidebar.classList.remove('open');
  cartOverlay.classList.remove('open');
  navbarCartIcon.setAttribute('aria-expanded', 'false');

  // Restore focus to the last focused element
  if (window.lastFocusedElement) {
    window.lastFocusedElement.focus();
  }
  // Enable background scroll
  document.body.style.overflow = '';
});

// Keyboard accessibility for cart icon
document.getElementById('navbarCartIcon').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    toggleCart();
  }
});


    function updateCart() {
      localStorage.setItem('product_cart', JSON.stringify(cart));
      updateCartUI();
    }

    async function updateCartUI() {
      // Update cart badge
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById('cartBadge').textContent = totalItems;
      
      // Update cart sidebar
      const cartContainer = document.getElementById('cartItemsContainer');
      
      if (cart.length === 0) {
        cartContainer.innerHTML = '<p class="text-muted text-center py-4">السلة فارغة</p>';
        document.getElementById('cartItemsCount').textContent = '0';
        document.getElementById('cartTotalAmount').textContent = '0.00 د.أ';
        return;
      }
      
      let html = '';
      let totalAmount = 0;
      
      // Prepare placeholders for images to be replaced asynchronously
      cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        totalAmount += itemTotal;
        
        html += `
          <div class="cart-item" id="cart-item-${item.pno}">
            <div class="d-flex align-items-center">
              <div class="cart-item-img me-2 bg-light d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                <div class="spinner-border text-primary" role="status" style="width:1.5rem; height:1.5rem;">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div>
                <h6 class="mb-0">${item.name}</h6>
                <small class="text-muted">${item.itemno} | ${item.price.toFixed(2)} د.أ</small>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <div class="quantity-control">
                <button class="btn btn-sm btn-outline-secondary quantity-btn" 
                  onclick="decrementCartQuantity('${item.pno}')">-</button>
                <span class="mx-2">${item.quantity}</span>
                <button class="btn btn-sm btn-outline-secondary quantity-btn" 
                  onclick="incrementCartQuantity('${item.pno}')">+</button>
              </div>
              <button class="btn btn-sm btn-outline-danger ms-2" 
                onclick="removeFromCart('${item.pno}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      
      cartContainer.innerHTML = html;
      document.getElementById('cartItemsCount').textContent = cart.length;
      document.getElementById('cartTotalAmount').textContent = totalAmount.toFixed(2) + ' د.أ';

      // Fetch images asynchronously and update each cart item
      for (const item of cart) {
        try {
          const response = await fetchWithAuth(`${baseUrl}/api/products/${item.pno}/get-images`);
          let imageUrl = '';
          if (response && Array.isArray(response.images) && response.images.length > 0) {
            imageUrl = `${baseUrl}${response.images[0]}`;
          }
          const cartItemDiv = document.getElementById(`cart-item-${item.pno}`);
          if (cartItemDiv) {
            const imgDiv = cartItemDiv.querySelector('.cart-item-img');
            if (imageUrl) {
              imgDiv.innerHTML = `<img src="${imageUrl}" class="cart-item-img me-2" alt="${item.name}" style="width:50px; height:50px; object-fit: contain; border-radius: 4px;">`;
            } else {
              imgDiv.innerHTML = `<div class="cart-item-img me-2 bg-light d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                <i class="bi bi-image text-muted"></i>
              </div>`;
            }
          }
        } catch (error) {
          console.error('Error fetching cart item image:', error);
        }
      }
    }

function addToCart(pno, itemno, name, price, image = '') {
  const existingItem = cart.find(item => item.pno === pno);
  
  if (existingItem) {
    existingItem.quantity += 1;
  } else {
    cart.push({
      pno,
      itemno,
      name,
      price: parseFloat(price),
      quantity: 1,
      image
    });
  }
  
  updateCart();
}

function addToCartWithQuantity(pno, itemno, name, price, image = '', quantity = 1) {
  quantity = parseInt(quantity);
  if (isNaN(quantity) || quantity <= 0) {
    alert('الرجاء إدخال كمية صحيحة أكبر من صفر.');
    return;
  }
  
  const existingItem = cart.find(item => item.pno === pno);
  
  if (existingItem) {
    existingItem.quantity = quantity;
  } else {
    cart.push({
      pno,
      itemno,
      name,
      price: parseFloat(price),
      quantity: quantity,
      image
    });
  }
  
  updateCart();
}

    function removeFromCart(pno) {
      const index = cart.findIndex(item => item.pno === pno);
      if (index !== -1) {
        cart.splice(index, 1);
        updateCart();
      }
      
      // Also update the quantity input in the product list
      const qtyInput = document.getElementById(`qty-${pno}`);
      if (qtyInput) {
        qtyInput.value = 0;
      }
    }

    function clearCart() {
      if (confirm('هل أنت متأكد أنك تريد إفراغ سلة الطلبات؟')) {
        cart.length = 0;
        updateCart();
        
        // Reset all quantity inputs
        document.querySelectorAll('.quantity-input').forEach(input => {
          input.value = 0;
        });
      }
    }

    function updateQuantity(pno, quantity) {
      quantity = parseInt(quantity) || 0;
      
      if (quantity < 0) {
        quantity = 0;
        document.getElementById(`qty-${pno}`).value = 0;
      }
      
      const productRow = document.querySelector(`tr[data-pno="${pno}"]`);
      if (!productRow) return;
      
      const itemno = productRow.querySelector('td:first-child').textContent;
      const name = productRow.querySelector('td:nth-child(6)').textContent;
      const price = parseFloat(productRow.querySelector('td:nth-child(7)').textContent);
      const image = productRow.querySelector('img')?.src || '';
      
      const existingItem = cart.find(item => item.pno === pno);
      
      if (quantity === 0) {
        if (existingItem) {
          removeFromCart(pno);
        }
        return;
      }
      
      if (existingItem) {
        existingItem.quantity = quantity;
      } else {
        cart.push({
          pno,
          itemno,
          name,
          price,
          quantity,
          image
        });
      }
      
      updateCart();
    }

    function incrementQuantity(pno) {
      const input = document.getElementById(`qty-${pno}`);
      input.value = parseInt(input.value) + 1;
      updateQuantity(pno, input.value);
    }

    function decrementQuantity(pno) {
      const input = document.getElementById(`qty-${pno}`);
      const newValue = Math.max(0, parseInt(input.value) - 1);
      input.value = newValue;
      updateQuantity(pno, newValue);
    }

    function incrementCartQuantity(pno) {
      const item = cart.find(item => item.pno === pno);
      if (item) {
        item.quantity += 1;
        updateCart();
        
        // Update the quantity input in the product list
        const qtyInput = document.getElementById(`qty-${pno}`);
        if (qtyInput) {
          qtyInput.value = item.quantity;
        }
      }
    }

    function decrementCartQuantity(pno) {
      const item = cart.find(item => item.pno === pno);
      if (item) {
        item.quantity = Math.max(0, item.quantity - 1);
        
        if (item.quantity === 0) {
          removeFromCart(pno);
        } else {
          updateCart();
          
          // Update the quantity input in the product list
          const qtyInput = document.getElementById(`qty-${pno}`);
          if (qtyInput) {
            qtyInput.value = item.quantity;
          }
        }
      }
    }

    async function submitOrder() {
      if (cart.length === 0) {
        alert('السلة فارغة. الرجاء إضافة منتجات قبل إرسال الطلب.');
        return;
      }
      
      const orderData = {
        items: cart.map(item => ({
          pno: item.pno,
          itemno: item.itemno,
          name: item.name,
          quantity: item.quantity,
          price: item.price
        })),
        total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
        notes: ''
      };
      
      try {
        // In a real application, you would send this to your backend
        // const response = await fetchWithAuth(`${baseUrl}/api/orders`, 'POST', orderData);
        
        // For demo purposes, we'll simulate a successful order
        const orderNumber = Math.floor(Math.random() * 1000000);
        document.getElementById('orderNumber').textContent = `ORD-${orderNumber}`;
        
        const modal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
        modal.show();
        
        // Clear the cart after successful order
        clearCart();
      } catch (error) {
        console.error('Order submission failed:', error);
        alert('حدث خطأ أثناء إرسال الطلب. الرجاء المحاولة مرة أخرى.');
      }
    }
  </script>
</body>
</html>