
{% extends 'CarPartsTemplates/base.html' %}

{% block title %}حسابي{% endblock %}

{% block content %}
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="stylesheet" href="{% static 'hozma/css/Dashboard.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>

   
    

   

    <div class="container my-4 text-end" dir="rtl">
        <h2 class="mb-4">مرحباً بك في لوحة تحكم قطع غيار السيارات، <span id="customerName" class="text-primary"></span></h2>
        
        <div class="row g-4">
            <!-- معلومات الحساب -->
            <div class="col-md-6">
                <div class="dashboard-section p-3 border rounded shadow-sm bg-light">
                    <h4><i class="fas fa-user me-2"></i>معلومات الحساب</h4>
                    <div id="customerDetails" class="details mt-3">
                        <!-- Client info will be injected here -->
                        <p>جاري تحميل بيانات العميل...</p>
                    </div>
                    
                       
                    
                    <button class="btn btn-outline-primary mt-3 w-100" onclick="editProfile()">تعديل الملف الشخصي</button>
                </div>
            </div>
    
            <!-- الإجراءات السريعة -->
            <div class="col-md-6">
                <div class="dashboard-section p-3 border rounded shadow-sm bg-light">
                    <h4><i class="fas fa-bolt me-2"></i>إجراءات سريعة</h4>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-primary" onclick="location.href='/shop'"><i class="fas fa-shopping-cart me-2"></i>متجر القطع</button>
                        <button class="btn btn-danger" onclick="location.href='/wishlist'"><i class="fas fa-heart me-2"></i>المفضلة</button>
                        <button class="btn btn-info" onclick="location.href='/track-order'"><i class="fas fa-truck me-2"></i>تتبع الطلب</button>
                        <button class="btn btn-dark" onclick="location.href='/support'"><i class="fas fa-headset me-2"></i>الدعم الفني</button>
                    </div>
                </div>
            </div>
    
            <!-- سجل الطلبات -->
            <div class="col-12">
                <div class="dashboard-section p-3 border rounded shadow-sm bg-light">
                    <h4><i class="fas fa-history me-2"></i>سجل الطلبات</h4>
                    <div id="orderHistory" class="mt-3">
                        <p>جاري تحميل سجل الطلبات...</p>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-secondary" onclick="location.href='/orders'">عرض جميع الطلبات</button>
                    </div>
                </div>
            </div>
    
            <!-- القطع التي تم الاطلاع عليها مؤخراً -->
            <div class="col-12">
                <div class="dashboard-section p-3 border rounded shadow-sm bg-light">
                    <h4><i class="fas fa-clock me-2"></i>القطع التي اطلعتها مؤخراً</h4>
                    <div id="recentlyViewed" class="row row-cols-1 row-cols-md-4 g-3 mt-3">
                        <p>جاري تحميل القطع...</p>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- زر التحميل لاختبار -->
       
    </div>
    

{% endblock %}
    





{% block extra_js %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
  
   
    
     <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Retrieve customer data from localStorage
            const customerId = JSON.parse(localStorage.getItem("session_data@user_id"));
            
            // Check if customer ID exists (user is logged in)
            if (customerId) {
                // Remove any prefix and keep only the number part
                const customerIdNumber = customerId.replace(/^c-/, '');
                
                // Update the dashboard with customer information
                fetchCustomerDetails(14);
                fetchOrderHistory(customerIdNumber);
                fetchRecentlyViewed(customerIdNumber);
            } else {
                // Redirect to login if no customer ID found
                window.location.href = "/login";
            }
        });
        
        // Function to fetch customer details
        function fetchCustomerDetails(customerId) {
    fetchWithAuth(`http://45.13.59.226/api/clients/${customerId}/`)
        .then(data => {
            if (!data || !data.clients || data.clients.length === 0) {
                console.error("No client data found.");
                return;
            }

            const client = data.clients[0]; // because you're using `filter()`, it returns a list

            console.log("Client Data:", client);

            displayClientData(client);
        })
        .catch(error => {
            console.error('Error fetching client data:', error);
        });
}

function displayClientData(clientData) {
    const detailsDiv = document.getElementById('customerDetails');

    const html = `
        <p><strong>الاسم:</strong> ${clientData.name || 'غير متوفر'}</p>
        <p><strong>العنوان:</strong> ${clientData.address || 'غير متوفر'}</p>
        <p><strong>رقم الهاتف:</strong> ${clientData.phone || 'غير متوفر'}</p>
        <p><strong>البريد الإلكتروني:</strong> ${clientData.email || 'غير متوفر'}</p>
        <p><strong>الموقع الإلكتروني:</strong> ${clientData.website || 'غير متوفر'}</p>
    `;

    detailsDiv.innerHTML = html;
}





        
        // Function to fetch order history
        // Function to fetch order history with debug logs
        function fetchOrderHistory(customerId) {
    console.log("Fetching order history for customer ID:", customerId);

    fetchWithAuth(`http://45.13.59.226/history/${customerId}/invoices/`)
        .then(invoices => {
            if (!invoices) {
                document.getElementById('orderHistory').innerHTML = "<p>حدث خطأ أثناء تحميل سجل الفواتير.</p>";
                return;
            }

            console.log("Fetched invoices:", invoices);

            const orderHistoryDiv = document.getElementById('orderHistory');

            if (invoices.length > 0) {
                let html = `<div class="orders-table">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>الكمية</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>`;

                const recentInvoices = invoices.slice(0, 3);
                console.log("Recent 3 invoices:", recentInvoices);

                recentInvoices.forEach(invoice => {
                    html += `
                        <tr>
                            <td>#${invoice.invoice_no}</td>
                            <td>${invoice.invoice_date}</td>
                            <td>${invoice.quantity} قطع</td>
                            <td>${invoice.amount} ر.س</td>
                            <td><span class="status">${invoice.invoice_status}</span></td>
                            <td><button class="btn btn-small" onclick="viewOrderDetails('${invoice.autoid}')">التفاصيل</button></td>
                        </tr>`;
                });

                html += `</tbody></table></div>`;
                orderHistoryDiv.innerHTML = html;
            } else {
                console.log("No invoices found.");
                orderHistoryDiv.innerHTML = "<p>لا توجد فواتير سابقة.</p>";
            }
        })
        .catch(error => {
            console.error('Error fetching invoice history:', error);
            document.getElementById('orderHistory').innerHTML = "<p>حدث خطأ أثناء تحميل سجل الفواتير.</p>";
        });
}



        
        // Function to fetch recently viewed products
        function fetchRecentlyViewed(customerId) {
            fetch(`https://api.yourcarparts.com/customers/${customerId}/recently-viewed/`)
                .then(response => response.json())
                .then(products => {
                    const recentlyViewedDiv = document.getElementById('recentlyViewed');
                    
                    if (products && products.length > 0) {
                        let html = '';
                        // Display last 4 viewed products
                        const recentProducts = products.slice(0, 4);
                        recentProducts.forEach(product => {
                            html += `
                            <div class="product-card">
                                <img src="${product.image}" alt="${product.name}">
                                <h4>${product.name}</h4>
                                <p class="price">${product.price} ر.س</p>
                                <button class="btn btn-small" onclick="location.href='/product/${product.id}'">عرض التفاصيل</button>
                            </div>`;
                        });
                        
                        recentlyViewedDiv.innerHTML = html;
                    } else {
                        recentlyViewedDiv.innerHTML = "<p>لا توجد قطع اطلعتها مؤخراً.</p>";
                    }
                })
                .catch(error => {
                    console.error('Error fetching recently viewed products:', error);
                    document.getElementById('recentlyViewed').innerHTML = "<p>حدث خطأ أثناء تحميل القطع.</p>";
                });
        }
        
        // Helper functions
        function editProfile() {
            window.location.href = "/profile/edit";
        }
        
        function viewOrderDetails(orderId) {
            window.location.href = `/orders/${orderId}`;
        }
        </script>
{% endblock %}
